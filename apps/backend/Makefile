# Revolution Backend Makefile
# WordPress Dockerç’°å¢ƒã®ç®¡ç†

.PHONY: sync-scripts build up down logs clean

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒæœŸ
sync-scripts:
	@echo "ğŸ“„ Syncing scripts from ../../scripts/"
	cp ../../scripts/setup-wordpress.sh ./setup-wordpress.sh
	chmod +x ./setup-wordpress.sh
	@echo "âœ… Scripts synced successfully"

# Dockerãƒ“ãƒ«ãƒ‰ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒæœŸä»˜ãï¼‰
build: sync-scripts
	@echo "ğŸ”¨ Building Docker image with latest scripts..."
	docker-compose build --no-cache
	@echo "âœ… Build completed"

# èµ·å‹•
up: build
	@echo "ğŸš€ Starting WordPress environment..."
	docker-compose up -d
	@echo "âœ… WordPress available at http://localhost:8080"

# åœæ­¢(ãƒ‡ãƒ¼ã‚¿ã¯å¼•ãç¶™ã)
stop:
	@echo "ğŸ›‘ Stopping WordPress environment..."
	docker-compose stop

# åœæ­¢(ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã‚‹) - ä½¿ç”¨æ³¨æ„ï¼
down:
	@echo "âš ï¸  è­¦å‘Š: down ã‚³ãƒãƒ³ãƒ‰ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã—ã¾ã™ã€‚"
	@echo "ä»£ã‚ã‚Šã« 'make stop' ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚"
	@echo "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ [y/N]: " && read ans && [ $${ans:-N} = y ]
	@echo "ğŸ›‘ Stopping WordPress environment..."
	docker-compose down

# ãƒ­ã‚°è¡¨ç¤º
logs:
	docker-compose logs -f

# å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆå±é™ºï¼šå…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼‰
clean:
	@echo "ğŸš¨ å±é™º: ã“ã®æ“ä½œã¯å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ï¼"
	@echo "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯å–å¾—æ¸ˆã¿ã§ã™ã‹ï¼Ÿ [y/N]: " && read ans && [ $${ans:-N} = y ]
	@make backup-all
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker-compose down -v
	docker image prune -f
	@echo "âœ… Cleanup completed"

# ========== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–¢é€£ ==========

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
backup-dir:
	@mkdir -p ./backups

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
backup-db: backup-dir
	@echo "ğŸ’¾ Backing up database..."
	@docker-compose exec -T mysql mysqldump -uroot -ppassword wordpress > ./backups/db_backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Database backup completed: ./backups/db_backup_$$(date +%Y%m%d_%H%M%S).sql"

# ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
backup-media: backup-dir
	@echo "ğŸ“¸ Backing up media files..."
	@tar -czf ./backups/media_backup_$$(date +%Y%m%d_%H%M%S).tar.gz ./wp-content/uploads 2>/dev/null || true
	@echo "âœ… Media backup completed: ./backups/media_backup_$$(date +%Y%m%d_%H%M%S).tar.gz"

# å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
backup-all: backup-dir
	@echo "ğŸ“¦ Starting full backup..."
	@make backup-db
	@make backup-media
	@echo "âœ… Full backup completed in ./backups/"
	@ls -lah ./backups/ | tail -n 5

# è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãï¼‰
auto-backup: backup-all
	@echo "ğŸ¤– Auto-backup completed at $$(date)"

# ========== ãƒªã‚¹ãƒˆã‚¢é–¢é€£ ==========

# æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒªã‚¹ãƒˆã‚¢
restore-db-latest:
	@echo "ğŸ”„ Restoring latest database backup..."
	@latest_db=$$(ls -t ./backups/db_backup_*.sql 2>/dev/null | head -n1); \
	if [ -z "$$latest_db" ]; then \
		echo "âŒ No database backup found"; \
		exit 1; \
	else \
		echo "ğŸ“‚ Restoring from: $$latest_db"; \
		docker-compose exec -T mysql mysql -uroot -ppassword wordpress < $$latest_db; \
		echo "âœ… Database restored successfully"; \
	fi

# æœ€æ–°ã®ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã‚¢
restore-media-latest:
	@echo "ğŸ”„ Restoring latest media backup..."
	@latest_media=$$(ls -t ./backups/media_backup_*.tar.gz 2>/dev/null | head -n1); \
	if [ -z "$$latest_media" ]; then \
		echo "âŒ No media backup found"; \
		exit 1; \
	else \
		echo "ğŸ“‚ Restoring from: $$latest_media"; \
		tar -xzf $$latest_media; \
		echo "âœ… Media files restored successfully"; \
	fi

# æœ€æ–°ã®å…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒªã‚¹ãƒˆã‚¢
restore-latest:
	@echo "ğŸ“¥ Restoring latest backups..."
	@make restore-db-latest
	@make restore-media-latest
	@echo "âœ… Full restore completed"

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªã‚¹ãƒˆè¡¨ç¤º
list-backups:
	@echo "ğŸ“‹ Available backups:"
	@echo "Database backups:"
	@ls -lah ./backups/db_backup_*.sql 2>/dev/null || echo "  No database backups found"
	@echo ""
	@echo "Media backups:"
	@ls -lah ./backups/media_backup_*.tar.gz 2>/dev/null || echo "  No media backups found"

# ========== å®‰å…¨ãªæ“ä½œ ==========

# å®‰å…¨ãªãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãï¼‰
safe-reset:
	@echo "ğŸ”„ Safe reset with automatic backup..."
	@make backup-all
	@echo "âš ï¸  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒªã‚»ãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ [y/N]: " && read ans && [ $${ans:-N} = y ]
	docker-compose down -v
	docker-compose up -d
	@echo "âœ… Reset completed. Use 'make restore-latest' to restore data."

# å®‰å…¨ãªå†èµ·å‹•
restart:
	@echo "ğŸ”„ Restarting WordPress environment (data preserved)..."
	docker-compose restart
	@echo "âœ… Restart completed"

# ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
verify-data:
	@echo "ğŸ” Verifying WordPress data..."
	@docker-compose exec mysql mysql -uroot -ppassword -e "USE wordpress; SELECT COUNT(*) as 'Total Posts' FROM wp_posts WHERE post_type='post';" 2>/dev/null || echo "Database not accessible"
	@echo ""
	@echo "Media files:"
	@find ./wp-content/uploads -type f 2>/dev/null | wc -l | xargs echo "  Total files:"

# ========== WP-CLIé–¢é€£ ==========

# WP-CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆWordPressã‚³ãƒ³ãƒ†ãƒŠå†…ï¼‰
# æ³¨: docker-compose exec ã¯ã‚µãƒ¼ãƒ“ã‚¹å(wordpress)ã‚’ä½¿ç”¨ã€docker exec ã¯ã‚³ãƒ³ãƒ†ãƒŠåã‚’ä½¿ç”¨
install-wp-cli:
	@echo "ğŸ“¦ Installing WP-CLI..."
	@docker-compose exec wordpress bash -c "curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar && chmod +x wp-cli.phar && mv wp-cli.phar /usr/local/bin/wp"
	@echo "âœ… WP-CLI installed"

# WP-CLIã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œï¼ˆã‚µãƒ¼ãƒ“ã‚¹åã‚’ä½¿ç”¨ï¼‰
wp-cli:
	@docker-compose exec wordpress wp --allow-root $(cmd)

# ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ä¸€è¦§
wp-plugins:
	@docker-compose exec wordpress wp --allow-root plugin list 2>/dev/null || echo "WP-CLI not installed. Run 'make install-wp-cli' first."

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
wp-users:
	@docker-compose exec wordpress wp --allow-root user list 2>/dev/null || echo "WP-CLI not installed. Run 'make install-wp-cli' first."

# ãƒ˜ãƒ«ãƒ—
help:
	@echo "Available commands:"
	@echo ""
	@echo "ğŸš€ Basic Operations:"
	@echo "  make up            - Build and start WordPress environment"
	@echo "  make stop          - Stop WordPress (data preserved)"
	@echo "  make restart       - Restart WordPress (data preserved)"
	@echo "  make logs          - Show container logs"
	@echo ""
	@echo "ğŸ’¾ Backup & Restore:"
	@echo "  make backup-all    - Backup database and media files"
	@echo "  make backup-db     - Backup database only"
	@echo "  make backup-media  - Backup media files only"
	@echo "  make restore-latest - Restore latest backups"
	@echo "  make list-backups  - List available backups"
	@echo ""
	@echo "ğŸ›¡ï¸ Safe Operations:"
	@echo "  make safe-reset    - Reset with automatic backup"
	@echo "  make verify-data   - Verify WordPress data integrity"
	@echo ""
	@echo "ğŸ”§ WP-CLI:"
	@echo "  make install-wp-cli - Install WP-CLI in WordPress container"
	@echo "  make wp-plugins    - List installed plugins"
	@echo "  make wp-users      - List WordPress users"
	@echo "  make wp-cli cmd='...' - Run WP-CLI command"
	@echo ""
	@echo "âš ï¸  Dangerous Operations:"
	@echo "  make down          - Stop and remove containers (use 'stop' instead)"
	@echo "  make clean         - Delete ALL data (requires confirmation)"
