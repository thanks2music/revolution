name: Deploy MDX Articles

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "apps/ai-writer/content/**/*.mdx"
  push:
    branches: [main]
    paths:
      - "apps/ai-writer/content/**/*.mdx"

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate article index
        run: |
          echo "ðŸ“ Generating article index..."
          echo "Current directory: $(pwd)"
          echo "Node version: $(node --version)"
          echo "pnpm version: $(pnpm --version)"

          cd apps/ai-writer && pnpm generate:article-index
          cd ../..  # ãƒªãƒã‚¸ãƒˆãƒªãƒ«ãƒ¼ãƒˆã«æˆ»ã‚‹

          if [ -f "apps/frontend/lib/mdx/article-index.json" ]; then
            echo "âœ… Article index generated successfully"
            echo "ðŸ“Š Index statistics:"
            cat apps/frontend/lib/mdx/article-index.json | jq -r '.articles | length' | xargs -I {} echo "  Total articles: {}"
            cat apps/frontend/lib/mdx/article-index.json | jq -r '.generatedAt' | xargs -I {} echo "  Generated at: {}"
            echo "ðŸ“„ File info:"
            ls -lh apps/frontend/lib/mdx/article-index.json
          else
            echo "âŒ Article index not found"
            echo "ðŸ“‚ Directory contents:"
            ls -la apps/frontend/lib/mdx/ || echo "Directory does not exist"
            exit 1
          fi

      - name: Commit article index (if changed)
        if: github.event_name == 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --exit-code apps/frontend/lib/mdx/article-index.json; then
            echo "No changes to article index"
          else
            git add apps/frontend/lib/mdx/article-index.json
            git commit -m "ðŸ“ Update article index [skip ci]"
            git push
          fi

      - name: Deploy to Vercel (Production)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "ðŸš€ Deploying to Vercel production..."
          echo "ðŸ”§ Environment:"
          echo "  Vercel Org ID: ${{ secrets.VERCEL_ORG_ID }}"
          echo "  Vercel Project ID: ${{ secrets.VERCEL_PROJECT_ID }}"
          echo "  Working directory: $(pwd)"
          cd apps/frontend

          # Vercel ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã€çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
          echo "ðŸ“¤ Starting deployment..."
          if pnpm deploy:prod --token=${{ secrets.VERCEL_TOKEN }}; then
            echo "âœ… Production deployment succeeded"
          else
            echo "âŒ Production deployment failed"
            echo "ðŸ“‹ Debug information:"
            echo "  Exit code: $?"
            echo "  Current directory: $(pwd)"
            ls -la
            exit 1
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (Preview)
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ” Deploying to Vercel preview..."
          echo "ðŸ”§ Environment:"
          echo "  Vercel Org ID: ${{ secrets.VERCEL_ORG_ID }}"
          echo "  Vercel Project ID: ${{ secrets.VERCEL_PROJECT_ID }}"
          echo "  PR Number: ${{ github.event.pull_request.number }}"
          echo "  Working directory: $(pwd)"
          cd apps/frontend

          # Vercel CLI ã®å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          echo "ðŸ“¤ Starting preview deployment..."
          set +e  # ä¸€æ™‚çš„ã«ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•çµ‚äº†ã‚’ç„¡åŠ¹åŒ–
          DEPLOY_OUTPUT=$(pnpm deploy:preview --token=${{ secrets.VERCEL_TOKEN }} 2>&1)
          DEPLOY_EXIT_CODE=$?
          set -e  # ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•çµ‚äº†ã‚’å†æœ‰åŠ¹åŒ–

          echo "ðŸ“‹ Deployment output:"
          echo "$DEPLOY_OUTPUT"
          echo ""

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸå ´åˆ
          if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
            echo "âŒ Vercel deployment failed with exit code: $DEPLOY_EXIT_CODE"
            echo "ðŸ“‹ Debug information:"
            echo "  Current directory: $(pwd)"
            echo "  Directory contents:"
            ls -la
            echo "VERCEL_DEPLOYMENT_URL=Deployment failed" >> $GITHUB_ENV
            exit 1
          fi

          # ãƒ‡ãƒ—ãƒ­ã‚¤ URL ã‚’æŠ½å‡ºã—ã¦ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "ðŸ” Extracting deployment URL..."
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' | head -n 1)

          if [ -n "$DEPLOY_URL" ]; then
            echo "VERCEL_DEPLOYMENT_URL=$DEPLOY_URL" >> $GITHUB_ENV
            echo "âœ… Deployment URL captured: $DEPLOY_URL"
          else
            echo "âš ï¸ Failed to capture deployment URL from output"
            echo "ðŸ“‹ Debug: Full output length: ${#DEPLOY_OUTPUT} characters"
            echo "VERCEL_DEPLOYMENT_URL=URL extraction failed" >> $GITHUB_ENV
            exit 1
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Comment PR with deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_URL: ${{ env.VERCEL_DEPLOYMENT_URL }}
        with:
          script: |
            const deploymentUrl = process.env.DEPLOYMENT_URL || 'Deployment URL not available';

            const comment = `## ðŸš€ Deployment Status

            | Status | URL |
            |--------|-----|
            | Preview | ${deploymentUrl} |

            **Article Index**: Generated successfully âœ…

            *This comment was automatically generated by GitHub Actions.*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: comment
            });
